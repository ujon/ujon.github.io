---
slug: 20251226__qr_order
title: "[시스템 디자인] QR 주문"
author: ujon
date: 2025-12-26
tags:
  - system-design
---

## 설명

해외 여행중 음식점에서 주문을 할때 좋은 경험을 주었던 QR코드 주문/결제 시스템을 최근 점심을 먹으러간 식당에서 보게되었고 이 시스템을 디자인해보기로했다.

## 조건

- QR코드를 스캔하여 주문할 수 있다
- 테이블마다 고유한 QR코드가 부착되어 있다
- 동일 테이블의 여러 고객이 실시간으로 장바구니를 공유하며 함께 주문할 수 있다
- 주문 완료 시 주방에서 즉시 확인할 수 있다
- 음식점 외부에서는 주문이 불가능하다

## 시스템 디자인

![system design](/asset/image/20251226_qr_order.png)

### Websocket Server

실시간 통신을 담당하며, 부하 분산을 위해 Client API, Admin API와 별도 인스턴스로 운영한다.

**주요 기능**

- 동일 테이블 고객 간 장바구니 실시간 동기화
- 주문 발생 시 주방 기기로 알림 전송

**구현 방식**

- 장바구니 동기화
  - Redis Pub/Sub으로 채널을 관리하여 수평 확장을 지원한다.
  - Pub/Sub은 메시지를 저장하지 않아 유실 가능성이 있지만, 장바구니는 주문 확인 과정에서 재동기화가 가능한 일회성 데이터이므로 streams을 사용하지는 않는다.
- 주문 처리
  - 주문은 반드시 주방에 전달되어야 하므로 Redis Streams를 사용
  - Consumer Group을 활용하여 처리 실패 시 재처리가 가능하도록 구현

### Client API

고객용 API를 제공한다.

**주요 기능**

- 메뉴 목록 조회
- 주문 접수

**구현 방식**

- 주문 접수
  - 주문 접수가 되면 메뉴 정합성을 체크하고 메뉴 수량이 한정적인 경우 동시성 이슈를 해결하기위해 Optimistic Lock을 적용
  - Redis Streams를 통해 주문 내용을 produce하여 주방에서 확인할 수 있도록 구현

**보안 고려사항**

음식점 외부에서의 주문을 차단하기 위해 다음 검증 로직이 필요하다.

- 클라이언트 IP 검증 (식당 네트워크 대역 확인)
- GPS 좌표 검증 (식당 위치와의 거리 계산)
- 두 가지 조건의 조합으로 우회 시도 방지

### Admin API

점주 및 직원용 API를 제공한다.

**주요 기능**

- 메뉴 등록 및 관리
- 테이블별 정산 금액 조회
- 주문 상태 관리

## 시퀀스

![sequencediagram](/asset/image/20251226_order_sq.svg)
